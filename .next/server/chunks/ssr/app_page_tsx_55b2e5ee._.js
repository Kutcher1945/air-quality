module.exports=[60350,a=>{"use strict";var b=a.i(87924),c=a.i(19721),d=a.i(72131),e=a.i(13749),f=a.i(50522),g=a.i(70106);let h=(0,g.default)("Moon",[["path",{d:"M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z",key:"a7tn18"}]]),i=(0,g.default)("Sun",[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]]);var j=a.i(13902),k=a.i(40695),l=a.i(3130),m=a.i(99863);let n=(0,c.default)(async()=>{},{loadableGenerated:{modules:[37154]},ssr:!1});function o(){let{resolvedTheme:a,setTheme:c}=(0,j.useTheme)(),[g,o]=(0,d.useState)(new Date().getFullYear()),[p,q]=(0,d.useState)({}),[r,s]=(0,d.useState)(null),[t,u]=(0,d.useState)(!0),[v,w]=(0,d.useState)([]),[x,y]=(0,d.useState)(!0),[z,A]=(0,d.useState)(null),[B,C]=(0,d.useState)(""),[D,E]=(0,d.useState)("all"),[F,G]=(0,d.useState)(!0),[H,I]=(0,d.useState)(!1),[J,K]=(0,d.useState)(!1),L="dark"===a,M=new Date().getFullYear(),N=(0,d.useCallback)(async()=>{try{y(!0),A(null);let a=await fetch("https://admin.smartalmaty.kz/api/v1/ecology/air-quality-sensors/?active=true",{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!a.ok)throw Error(`Sensors API returned ${a.status}`);let b=await a.json(),c=(Array.isArray(b)?b:b?.results||[]).filter(a=>null!==a.latitude&&void 0!==a.latitude&&null!==a.longitude&&void 0!==a.longitude);w(c)}catch(a){console.error("Failed to fetch sensor data:",a),w([]),A("Не удалось загрузить список сенсоров")}finally{y(!1)}},[]);(0,d.useEffect)(()=>{(async()=>{try{let a;u(!0);let b=await fetch(`https://admin.smartalmaty.kz/api/v1/ecology/api/air-quality-calendar/?year=${g}`,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!b.ok)throw Error(`API returned ${b.status}`);let c=b.headers.get("content-type");if(!c||!c.includes("application/json"))throw Error("Response is not JSON");let d=await b.json(),e={};d.data?.forEach(a=>{null!==a.avg_pm25&&void 0!==a.avg_pm25&&(e[a.date]=a.avg_pm25)}),q(e);let f=(a=Object.values(e||{})).length?{total_days:a.length,good_days:a.filter(a=>a<=15).length,moderate_days:a.filter(a=>a>15&&a<=35).length,sensitive_days:a.filter(a=>a>35&&a<=55).length,unhealthy_days:a.filter(a=>a>55&&a<=150).length,very_unhealthy_days:a.filter(a=>a>150&&a<=250).length,hazardous_days:a.filter(a=>a>250).length,avg_pm25:a.reduce((a,b)=>a+b,0)/a.length,max_pm25:Math.max(...a),min_pm25:Math.min(...a)}:null,h=(a=>{if(!a)return null;let b=a.pm25||{};return{total_days:a.total_days??0,good_days:b.good_days??0,moderate_days:b.moderate_days??0,sensitive_days:b.sensitive_days??0,unhealthy_days:b.unhealthy_days??0,very_unhealthy_days:b.very_unhealthy_days??0,hazardous_days:b.hazardous_days??0,avg_pm25:b.avg??void 0,max_pm25:b.max??void 0,min_pm25:b.min??void 0}})(d.stats);s(f||h)}catch(a){console.error("Failed to fetch air quality data:",a),q({}),s(null)}finally{u(!1)}})()},[g]),(0,d.useEffect)(()=>{N()},[N]);let O=(0,d.useMemo)(()=>{let a=new Set;return v.forEach(b=>{b.district&&a.add(b.district)}),Array.from(a).sort()},[v]),P=(0,d.useMemo)(()=>v.filter(a=>{if(F&&!1===a.is_active||"all"!==D&&a.district!==D)return!1;if(H){let b=a.latest_measurement;if(!b||null===b.pm25||void 0===b.pm25)return!1}if(B.trim()){let b=B.toLowerCase(),c=a.name?.toLowerCase()||"",d=a.district?.toLowerCase()||"";if(!c.includes(b)&&!d.includes(b))return!1}return!0}),[v,F,D,H,B]),Q=(0,d.useMemo)(()=>v.filter(a=>!1!==a.is_active),[v]),R=(0,d.useMemo)(()=>v.filter(a=>a.latest_measurement&&null!==a.latest_measurement.pm25&&void 0!==a.latest_measurement.pm25),[v]);(0,d.useMemo)(()=>{let a=v.map(a=>a.latest_measurement?.datetime).filter(a=>!!a);return a.length?new Date(Math.max(...a.map(a=>new Date(a).getTime()))).toISOString():null},[v]);let S=(0,d.useMemo)(()=>{let a=new Map;return v.forEach(b=>{let c=b.district||"Unknown";a.has(c)||a.set(c,{sensors:[],pm25Values:[]});let d=a.get(c);d.sensors.push(b),b.latest_measurement?.pm25!==null&&b.latest_measurement?.pm25!==void 0&&d.pm25Values.push(b.latest_measurement.pm25)}),Array.from(a.entries()).map(([a,b])=>{let c=b.pm25Values,d=c.length>0?c.reduce((a,b)=>a+b,0)/c.length:null;return{supplier:a,totalSensors:b.sensors.length,activeSensors:b.sensors.filter(a=>!1!==a.is_active).length,sensorsWithData:c.length,avgPM25:d,goodCount:c.filter(a=>a<=15).length,moderateCount:c.filter(a=>a>15&&a<=35).length,sensitiveCount:c.filter(a=>a>35&&a<=55).length,unhealthyCount:c.filter(a=>a>55&&a<=150).length,veryUnhealthyCount:c.filter(a=>a>150&&a<=250).length,hazardousCount:c.filter(a=>a>250).length}}).sort((a,b)=>b.totalSensors-a.totalSensors)},[v]);(0,d.useEffect)(()=>{K(!0)},[]);let T=(0,d.useMemo)(()=>{let a=Object.keys(p||{});return a.length?new Date(Math.max(...a.map(a=>new Date(a).getTime()))).toISOString():null},[p]),U=()=>{g>2019&&o(g-1)},V=()=>{g<M&&o(g+1)},W=g>2019,X=g<M;return(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(m.HeaderMenu,{}),(0,b.jsx)("main",{className:"min-h-screen bg-background",children:(0,b.jsxs)("div",{className:"w-full px-4 pb-12 pt-8 md:px-8",children:[(0,b.jsxs)("header",{className:"mb-8 flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-xs uppercase tracking-[0.2em] text-muted-foreground",children:"Air Quality / Алматы"}),(0,b.jsx)("h1",{className:"text-4xl font-bold text-foreground",children:"Календарь качества воздуха"}),(0,b.jsxs)("p",{className:"text-muted-foreground",children:["PM2.5 с 9 января 2019 по сегодня. Последние данные календаря:"," ",T?new Date(T).toLocaleDateString("ru-RU"):"—"]})]}),(0,b.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,b.jsxs)(k.Button,{variant:"outline",size:"sm",onClick:U,className:"border-border bg-transparent",disabled:!W,children:[(0,b.jsx)(e.ChevronLeft,{className:"mr-1 h-4 w-4"}),"Предыдущий год"]}),(0,b.jsxs)(k.Button,{variant:"outline",size:"sm",onClick:V,className:"border-border bg-transparent",disabled:!X,children:["Следующий год",(0,b.jsx)(f.ChevronRight,{className:"ml-1 h-4 w-4"})]}),(0,b.jsx)(k.Button,{variant:"outline",size:"icon",onClick:()=>{c(L?"light":"dark")},className:"border-border bg-transparent","aria-label":"Toggle theme",children:J?L?(0,b.jsx)(i,{className:"h-4 w-4"}):(0,b.jsx)(h,{className:"h-4 w-4"}):(0,b.jsx)("div",{className:"h-4 w-4"})})]})]}),r&&(0,b.jsxs)("div",{className:"mb-8 grid grid-cols-2 gap-3 md:grid-cols-3 lg:grid-cols-6",children:[(0,b.jsx)(l.Card,{className:"bg-card border-border",children:(0,b.jsxs)(l.CardContent,{className:"pt-4",children:[(0,b.jsx)("p",{className:"mb-1 text-xs text-muted-foreground",children:"Всего дней"}),(0,b.jsx)("p",{className:"text-2xl font-bold text-foreground",children:r.total_days})]})}),(0,b.jsx)(l.Card,{className:"bg-card border-border",children:(0,b.jsxs)(l.CardContent,{className:"pt-4",children:[(0,b.jsx)("p",{className:"mb-1 text-xs text-muted-foreground",children:"Среднее PM2.5"}),(0,b.jsx)("p",{className:"text-2xl font-bold text-foreground",children:r.avg_pm25?.toFixed(1)||"—"})]})}),(0,b.jsx)(l.Card,{className:"bg-card border-border",children:(0,b.jsxs)(l.CardContent,{className:"pt-4",children:[(0,b.jsx)("p",{className:"mb-1 text-xs text-muted-foreground",children:"Хорошие дни"}),(0,b.jsx)("p",{className:"text-2xl font-bold text-aqi-good",children:r.good_days})]})}),(0,b.jsx)(l.Card,{className:"bg-card border-border",children:(0,b.jsxs)(l.CardContent,{className:"pt-4",children:[(0,b.jsx)("p",{className:"mb-1 text-xs text-muted-foreground",children:"Умеренные дни"}),(0,b.jsx)("p",{className:"text-2xl font-bold text-aqi-moderate",children:r.moderate_days})]})}),(0,b.jsx)(l.Card,{className:"bg-card border-border",children:(0,b.jsxs)(l.CardContent,{className:"pt-4",children:[(0,b.jsx)("p",{className:"mb-1 text-xs text-muted-foreground",children:"Вредные дни"}),(0,b.jsx)("p",{className:"text-2xl font-bold text-aqi-unhealthy",children:r.unhealthy_days})]})}),(0,b.jsx)(l.Card,{className:"bg-card border-border",children:(0,b.jsxs)(l.CardContent,{className:"pt-4",children:[(0,b.jsx)("p",{className:"mb-1 text-xs text-muted-foreground",children:"Опасные дни"}),(0,b.jsx)("p",{className:"text-2xl font-bold text-aqi-hazardous",children:r.hazardous_days})]})})]}),S.length>0&&(0,b.jsxs)("div",{className:"mb-8",children:[(0,b.jsx)("h2",{className:"mb-4 text-2xl font-bold text-foreground",children:"Статистика по поставщикам"}),(0,b.jsx)("div",{className:"grid grid-cols-2 gap-3 md:grid-cols-3 lg:grid-cols-5",children:S.map(a=>(0,b.jsx)(l.Card,{className:"bg-card border-border",children:(0,b.jsxs)(l.CardContent,{className:"pt-4",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,b.jsx)("div",{className:"h-3 w-3 rounded-full",style:{backgroundColor:(a=>{let b={AirGradient:"#3b82f6",AirKaz:"#10b981","Citizen Science project sensor.community":"#f59e0b","Clarity Node":"#8b5cf6",IQAir:"#ef4444",OpenAQ:"#06b6d4",PurpleAir:"#ec4899","Reference Site":"#14b8a6"};if(b[a])return b[a];let c=0;for(let b=0;b<a.length;b++)c=a.charCodeAt(b)+((c<<5)-c);let d=c%360;return`hsl(${d}, 70%, 50%)`})(a.supplier)}}),(0,b.jsx)("p",{className:"text-sm font-semibold text-foreground",children:a.supplier})]}),(0,b.jsx)("p",{className:"text-3xl font-bold text-foreground mb-1",children:a.totalSensors}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:"сенсоров"})]})},a.supplier))})]}),(0,b.jsxs)(l.Card,{className:"mb-8 bg-card border-border",children:[(0,b.jsx)(l.CardHeader,{className:"border-b border-border",children:(0,b.jsxs)("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(l.CardTitle,{className:"text-2xl",children:"Карта сенсоров воздуха"}),(0,b.jsxs)(l.CardDescription,{children:[P.length," из ",v.length," сенсоров отображены · Активных: ",Q.length," · С данными PM2.5: ",R.length]})]}),(0,b.jsx)("div",{className:"flex gap-2",children:(0,b.jsx)(k.Button,{variant:"outline",size:"sm",onClick:()=>{C(""),E("all"),G(!0),I(!1)},className:"border-border",children:"Сбросить фильтры"})})]})}),(0,b.jsxs)(l.CardContent,{className:"space-y-4 p-4",children:[(0,b.jsxs)("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-4 md:items-end",children:[(0,b.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,b.jsx)("label",{className:"text-sm text-muted-foreground",children:"Поиск по названию или поставщику"}),(0,b.jsx)("input",{type:"text",value:B,onChange:a=>C(a.target.value),placeholder:"Например, Алмалинский",className:"h-10 rounded-md border border-border bg-background px-3 text-sm"})]}),(0,b.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,b.jsx)("label",{className:"text-sm text-muted-foreground",children:"Поставщик"}),(0,b.jsxs)("select",{value:D,onChange:a=>E(a.target.value),className:"h-10 rounded-md border border-border bg-background px-3 text-sm",children:[(0,b.jsx)("option",{value:"all",children:"Все поставщики"}),O.map(a=>(0,b.jsx)("option",{value:a,children:a},a))]})]}),(0,b.jsx)("div",{className:"flex items-center gap-4"})]}),x?(0,b.jsx)("div",{className:"flex h-[480px] items-center justify-center text-muted-foreground",children:"Загрузка сенсоров…"}):z?(0,b.jsxs)("div",{className:"flex h-[480px] flex-col items-center justify-center gap-3 text-center",children:[(0,b.jsx)("p",{className:"text-red-500 font-semibold",children:z}),(0,b.jsx)(k.Button,{variant:"outline",size:"sm",onClick:N,className:"border-border",children:"Попробовать снова"})]}):(0,b.jsx)("div",{className:"relative h-[600px]",children:(0,b.jsx)(n,{sensors:P})})]})]}),(0,b.jsxs)(l.Card,{className:"bg-card border-border",children:[(0,b.jsx)(l.CardHeader,{className:"border-b border-border",children:(0,b.jsxs)("div",{className:"flex flex-col items-start justify-between gap-4 md:flex-row md:items-center",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(l.CardTitle,{className:"text-2xl",children:g}),(0,b.jsx)(l.CardDescription,{children:"Отслеживайте ежедневный уровень качества воздуха за весь год"})]}),(0,b.jsxs)("div",{className:"flex gap-2",children:[(0,b.jsxs)(k.Button,{variant:"outline",size:"sm",onClick:U,className:"border-border bg-transparent",disabled:!W,children:[(0,b.jsx)(e.ChevronLeft,{className:"mr-1 h-4 w-4"}),"Предыдущий год"]}),(0,b.jsxs)(k.Button,{variant:"outline",size:"sm",onClick:V,className:"border-border bg-transparent",disabled:!X,children:["Следующий год",(0,b.jsx)(f.ChevronRight,{className:"ml-1 h-4 w-4"})]})]})]})}),(0,b.jsxs)(l.CardContent,{className:"p-6",children:[t?(0,b.jsx)("div",{className:"py-12 text-center",children:(0,b.jsx)("p",{className:"text-muted-foreground",children:"Загрузка данных о качестве воздуха..."})}):0===Object.keys(p).length?(0,b.jsxs)("div",{className:"py-12 text-center",children:[(0,b.jsx)("p",{className:"mb-2 font-semibold text-red-500",children:"Ошибка загрузки данных"}),(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"Проверьте консоль браузера для деталей. Убедитесь, что API доступен и возвращает JSON."})]}):(0,b.jsx)("div",{className:"mb-8 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3",children:Array.from({length:12},(a,c)=>{var d;let e,f,h,i,j;return e=new Date(g,d=c).toLocaleDateString("ru-RU",{month:"long"}),f=new Date(g,d+1,0).getDate(),h=new Date(g,d,1).getDay(),i=Array.from({length:f},(a,b)=>b+1),j=Array.from({length:h},(a,b)=>b),(0,b.jsxs)("div",{className:"bg-muted/50 rounded-lg p-4 border border-border",children:[(0,b.jsx)("h3",{className:"text-center font-semibold text-foreground mb-3 text-sm capitalize",children:e}),(0,b.jsx)("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["Вс","Пн","Вт","Ср","Чт","Пт","Сб"].map(a=>(0,b.jsx)("div",{className:"text-center font-semibold text-foreground text-xs h-6 flex items-center justify-center",children:a},a))}),(0,b.jsxs)("div",{className:"grid grid-cols-7 gap-1",children:[j.map(a=>(0,b.jsx)("div",{className:"aspect-square"},`empty-${a}`)),i.map(a=>{let c=p[`${g}-${String(d+1).padStart(2,"0")}-${String(a).padStart(2,"0")}`],e=void 0!==c?c<=15?{label:"Хорошо",color:"bg-aqi-good",textColor:"text-white"}:c<=35?{label:"Умеренно",color:"bg-aqi-moderate",textColor:"text-white"}:c<=55?{label:"Чувствительные группы",color:"bg-aqi-sensitive",textColor:"text-white"}:c<=150?{label:"Вредно",color:"bg-aqi-unhealthy",textColor:"text-white"}:c<=250?{label:"Очень вредно",color:"bg-aqi-very-unhealthy",textColor:"text-white"}:{label:"Опасно",color:"bg-aqi-hazardous",textColor:"text-white"}:null;return(0,b.jsxs)("div",{className:`aspect-square rounded-md border border-border flex flex-col items-center justify-center p-1 text-xs ${e?e.color:"bg-background"}`,children:[(0,b.jsx)("span",{className:`font-semibold ${e?e.textColor:"text-foreground"}`,children:a}),void 0!==c&&(0,b.jsx)("span",{className:`text-xs font-bold ${e?.textColor||"text-foreground"}`,children:c.toFixed(0)})]},a)})]})]},d)})}),(0,b.jsx)("div",{className:"mt-8 grid grid-cols-2 gap-4 md:grid-cols-3 lg:grid-cols-6",children:[{label:"Хорошо",range:"0-15",className:"bg-aqi-good"},{label:"Умеренно",range:"16-35",className:"bg-aqi-moderate"},{label:"Чувствительные",range:"36-55",className:"bg-aqi-sensitive"},{label:"Вредно",range:"56-150",className:"bg-aqi-unhealthy"},{label:"Очень вредно",range:"151-250",className:"bg-aqi-very-unhealthy"},{label:"Опасно",range:"250+",className:"bg-aqi-hazardous"}].map(a=>(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)("div",{className:`h-8 w-8 rounded ${a.className}`}),(0,b.jsxs)("div",{className:"leading-tight",children:[(0,b.jsx)("p",{className:"text-sm text-foreground",children:a.label}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:a.range})]})]},a.label))})]})]})]})})]})}a.s(["default",()=>o],60350)}];

//# sourceMappingURL=app_page_tsx_55b2e5ee._.js.map