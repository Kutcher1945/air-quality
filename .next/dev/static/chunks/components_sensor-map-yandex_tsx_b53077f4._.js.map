{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/adilannister/admin_related/air-quality-data/components/sensor-map-yandex.tsx"],"sourcesContent":["\"use client\"\n\nimport { useMemo, useState } from \"react\"\nimport { CircleMarker, MapContainer, Popup, TileLayer } from \"react-leaflet\"\nimport { CRS } from \"leaflet\"\nimport type { LatLngExpression } from \"leaflet\"\nimport \"leaflet/dist/leaflet.css\"\n\nexport interface SensorMetric {\n  pm25?: number | null\n  no2?: number | null\n  datetime?: string | null\n  interval?: string | null\n}\n\nexport interface Sensor {\n  id: number | string\n  sensor_id: string\n  name?: string | null\n  district?: string | null\n  latitude?: number | null\n  longitude?: number | null\n  is_active?: boolean\n  latest_measurement?: SensorMetric | null\n}\n\ninterface SensorMapProps {\n  sensors: Sensor[]\n}\n\ntype DailyStat = {\n  pm25?: number\n  no2?: number\n  datetime?: string\n}\n\nconst DEFAULT_CENTER: LatLngExpression = [43.238949, 76.889709] // Almaty\n\nconst YANDEX_TILE_URL =\n  \"https://core-renderer-tiles.maps.yandex.net/tiles?l=map&x={x}&y={y}&z={z}&lang=ru_RU\"\n\nconst getMarkerColor = (pm25?: number | null) => {\n  if (pm25 === null || pm25 === undefined) return \"#6b7280\"\n  if (pm25 <= 15) return \"#1BA97C\"\n  if (pm25 <= 35) return \"#f59e0b\"\n  if (pm25 <= 55) return \"#f97316\"\n  if (pm25 <= 150) return \"#ef4444\"\n  if (pm25 <= 250) return \"#a855f7\"\n  return \"#581c87\"\n}\n\nexport default function SensorMapYandex({ sensors }: SensorMapProps) {\n  const [dailyStats, setDailyStats] = useState<Record<string, DailyStat | null>>({})\n  const [loadingIds, setLoadingIds] = useState<Set<string>>(new Set())\n\n  const markers = useMemo(\n    () => sensors.filter((sensor) => sensor.latitude !== null && sensor.latitude !== undefined && sensor.longitude !== null && sensor.longitude !== undefined),\n    [sensors],\n  )\n\n  const fetchDailyStat = async (sensorId: string) => {\n    if (!sensorId) return\n    if (dailyStats[sensorId] !== undefined) return\n    if (loadingIds.has(sensorId)) return\n\n    const nextLoading = new Set(loadingIds)\n    nextLoading.add(sensorId)\n    setLoadingIds(nextLoading)\n\n    try {\n      const resp = await fetch(`https://api.air.org.kz/api/stats/daily?station_id=${sensorId}`)\n      if (!resp.ok) throw new Error(`Failed ${resp.status}`)\n      const data = await resp.json()\n      const first = Array.isArray(data) ? data[0] : data?.[0] || data\n      const stat: DailyStat = {\n        pm25: first?.pm25 ?? first?.avg_pm25 ?? first?.value,\n        no2: first?.no2,\n        datetime: first?.datetime || first?.date,\n      }\n      setDailyStats((prev) => ({ ...prev, [sensorId]: stat }))\n    } catch (_err) {\n      setDailyStats((prev) => ({ ...prev, [sensorId]: null }))\n    } finally {\n      const updated = new Set(nextLoading)\n      updated.delete(sensorId)\n      setLoadingIds(updated)\n    }\n  }\n\n  if (!markers.length) {\n    return (\n      <div className=\"flex h-[480px] items-center justify-center rounded-xl border border-dashed border-border bg-muted/40 text-muted-foreground\">\n        Нет данных по сенсорам для отображения\n      </div>\n    )\n  }\n\n  return (\n    <MapContainer\n      center={DEFAULT_CENTER}\n      zoom={11}\n      scrollWheelZoom\n      crs={CRS.EPSG3395}\n      className=\"h-[480px] w-full rounded-xl border border-border\"\n    >\n      <TileLayer attribution=\"&copy; Yandex\" url={YANDEX_TILE_URL} maxZoom={18} minZoom={0} />\n      {markers.map((sensor) => {\n        const metric = sensor.latest_measurement\n        const color = getMarkerColor(metric?.pm25)\n        const coords: LatLngExpression = [Number(sensor.latitude), Number(sensor.longitude)]\n        const sensorKey = sensor.sensor_id.toString()\n        const currentDaily = dailyStats[sensorKey]\n        const isLoadingDaily = loadingIds.has(sensorKey)\n\n        return (\n          <CircleMarker\n            key={sensorKey}\n            center={coords}\n            radius={10}\n            pathOptions={{\n              color,\n              fillColor: color,\n              fillOpacity: 0.85,\n              weight: 2,\n            }}\n            eventHandlers={{\n              click: () => fetchDailyStat(sensorKey),\n              popupopen: () => fetchDailyStat(sensorKey),\n            }}\n          >\n            <Popup>\n              <div className=\"space-y-1 text-sm\">\n                <p className=\"font-semibold text-foreground\">{sensor.name || \"Станция\"}</p>\n                {sensor.district && <p className=\"text-muted-foreground\">Поставщик: {sensor.district}</p>}\n                {metric ? (\n                  <>\n                    {metric.pm25 !== null && metric.pm25 !== undefined && (\n                      <p>\n                        PM2.5: <span className=\"font-semibold\">{metric.pm25}</span>\n                      </p>\n                    )}\n                    {metric.no2 !== null && metric.no2 !== undefined && (\n                      <p>\n                        NO2: <span className=\"font-semibold\">{metric.no2}</span>\n                      </p>\n                    )}\n                    {metric.datetime && <p className=\"text-xs text-muted-foreground\">Обновлено: {new Date(metric.datetime).toLocaleString()}</p>}\n                  </>\n                ) : (\n                  <p className=\"text-muted-foreground\">Нет свежих измерений (подгружаем суточные)</p>\n                )}\n                {isLoadingDaily && <p className=\"text-xs text-muted-foreground\">Подгружаем суточные данные…</p>}\n                {!isLoadingDaily && currentDaily === null && (\n                  <p className=\"text-muted-foreground\">Суточные данные отсутствуют</p>\n                )}\n                {!isLoadingDaily && currentDaily && (\n                  <>\n                    {currentDaily.pm25 !== undefined && currentDaily.pm25 !== null && (\n                      <p>\n                        Текущее (api/stats/daily): <span className=\"font-semibold\">{currentDaily.pm25}</span>\n                      </p>\n                    )}\n                    {currentDaily.no2 !== undefined && currentDaily.no2 !== null && (\n                      <p>\n                        NO2 (суточн.): <span className=\"font-semibold\">{currentDaily.no2}</span>\n                      </p>\n                    )}\n                    {currentDaily.datetime && (\n                      <p className=\"text-xs text-muted-foreground\">\n                        Обновлено (api/stats/daily): {new Date(currentDaily.datetime).toLocaleString()}\n                      </p>\n                    )}\n                  </>\n                )}\n              </div>\n            </Popup>\n          </CircleMarker>\n        )\n      })}\n    </MapContainer>\n  )\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AAAA;AAAA;AAAA;AACA;;;AAJA;;;;;AAoCA,MAAM,iBAAmC;IAAC;IAAW;CAAU,CAAC,SAAS;;AAEzE,MAAM,kBACJ;AAEF,MAAM,iBAAiB,CAAC;IACtB,IAAI,SAAS,QAAQ,SAAS,WAAW,OAAO;IAChD,IAAI,QAAQ,IAAI,OAAO;IACvB,IAAI,QAAQ,IAAI,OAAO;IACvB,IAAI,QAAQ,IAAI,OAAO;IACvB,IAAI,QAAQ,KAAK,OAAO;IACxB,IAAI,QAAQ,KAAK,OAAO;IACxB,OAAO;AACT;AAEe,SAAS,gBAAgB,EAAE,OAAO,EAAkB;;IACjE,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,yKAAQ,EAAmC,CAAC;IAChF,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,yKAAQ,EAAc,IAAI;IAE9D,MAAM,UAAU,IAAA,wKAAO;4CACrB,IAAM,QAAQ,MAAM;oDAAC,CAAC,SAAW,OAAO,QAAQ,KAAK,QAAQ,OAAO,QAAQ,KAAK,aAAa,OAAO,SAAS,KAAK,QAAQ,OAAO,SAAS,KAAK;;2CAChJ;QAAC;KAAQ;IAGX,MAAM,iBAAiB,OAAO;QAC5B,IAAI,CAAC,UAAU;QACf,IAAI,UAAU,CAAC,SAAS,KAAK,WAAW;QACxC,IAAI,WAAW,GAAG,CAAC,WAAW;QAE9B,MAAM,cAAc,IAAI,IAAI;QAC5B,YAAY,GAAG,CAAC;QAChB,cAAc;QAEd,IAAI;YACF,MAAM,OAAO,MAAM,MAAM,CAAC,kDAAkD,EAAE,UAAU;YACxF,IAAI,CAAC,KAAK,EAAE,EAAE,MAAM,IAAI,MAAM,CAAC,OAAO,EAAE,KAAK,MAAM,EAAE;YACrD,MAAM,OAAO,MAAM,KAAK,IAAI;YAC5B,MAAM,QAAQ,MAAM,OAAO,CAAC,QAAQ,IAAI,CAAC,EAAE,GAAG,MAAM,CAAC,EAAE,IAAI;YAC3D,MAAM,OAAkB;gBACtB,MAAM,OAAO,QAAQ,OAAO,YAAY,OAAO;gBAC/C,KAAK,OAAO;gBACZ,UAAU,OAAO,YAAY,OAAO;YACtC;YACA,cAAc,CAAC,OAAS,CAAC;oBAAE,GAAG,IAAI;oBAAE,CAAC,SAAS,EAAE;gBAAK,CAAC;QACxD,EAAE,OAAO,MAAM;YACb,cAAc,CAAC,OAAS,CAAC;oBAAE,GAAG,IAAI;oBAAE,CAAC,SAAS,EAAE;gBAAK,CAAC;QACxD,SAAU;YACR,MAAM,UAAU,IAAI,IAAI;YACxB,QAAQ,MAAM,CAAC;YACf,cAAc;QAChB;IACF;IAEA,IAAI,CAAC,QAAQ,MAAM,EAAE;QACnB,qBACE,6LAAC;YAAI,WAAU;sBAA6H;;;;;;IAIhJ;IAEA,qBACE,6LAAC,0KAAY;QACX,QAAQ;QACR,MAAM;QACN,eAAe;QACf,KAAK,2JAAG,CAAC,QAAQ;QACjB,WAAU;;0BAEV,6LAAC,oKAAS;gBAAC,aAAY;gBAAgB,KAAK;gBAAiB,SAAS;gBAAI,SAAS;;;;;;YAClF,QAAQ,GAAG,CAAC,CAAC;gBACZ,MAAM,SAAS,OAAO,kBAAkB;gBACxC,MAAM,QAAQ,eAAe,QAAQ;gBACrC,MAAM,SAA2B;oBAAC,OAAO,OAAO,QAAQ;oBAAG,OAAO,OAAO,SAAS;iBAAE;gBACpF,MAAM,YAAY,OAAO,SAAS,CAAC,QAAQ;gBAC3C,MAAM,eAAe,UAAU,CAAC,UAAU;gBAC1C,MAAM,iBAAiB,WAAW,GAAG,CAAC;gBAEtC,qBACE,6LAAC,0KAAY;oBAEX,QAAQ;oBACR,QAAQ;oBACR,aAAa;wBACX;wBACA,WAAW;wBACX,aAAa;wBACb,QAAQ;oBACV;oBACA,eAAe;wBACb,OAAO,IAAM,eAAe;wBAC5B,WAAW,IAAM,eAAe;oBAClC;8BAEA,cAAA,6LAAC,4JAAK;kCACJ,cAAA,6LAAC;4BAAI,WAAU;;8CACb,6LAAC;oCAAE,WAAU;8CAAiC,OAAO,IAAI,IAAI;;;;;;gCAC5D,OAAO,QAAQ,kBAAI,6LAAC;oCAAE,WAAU;;wCAAwB;wCAAY,OAAO,QAAQ;;;;;;;gCACnF,uBACC;;wCACG,OAAO,IAAI,KAAK,QAAQ,OAAO,IAAI,KAAK,2BACvC,6LAAC;;gDAAE;8DACM,6LAAC;oDAAK,WAAU;8DAAiB,OAAO,IAAI;;;;;;;;;;;;wCAGtD,OAAO,GAAG,KAAK,QAAQ,OAAO,GAAG,KAAK,2BACrC,6LAAC;;gDAAE;8DACI,6LAAC;oDAAK,WAAU;8DAAiB,OAAO,GAAG;;;;;;;;;;;;wCAGnD,OAAO,QAAQ,kBAAI,6LAAC;4CAAE,WAAU;;gDAAgC;gDAAY,IAAI,KAAK,OAAO,QAAQ,EAAE,cAAc;;;;;;;;iEAGvH,6LAAC;oCAAE,WAAU;8CAAwB;;;;;;gCAEtC,gCAAkB,6LAAC;oCAAE,WAAU;8CAAgC;;;;;;gCAC/D,CAAC,kBAAkB,iBAAiB,sBACnC,6LAAC;oCAAE,WAAU;8CAAwB;;;;;;gCAEtC,CAAC,kBAAkB,8BAClB;;wCACG,aAAa,IAAI,KAAK,aAAa,aAAa,IAAI,KAAK,sBACxD,6LAAC;;gDAAE;8DAC0B,6LAAC;oDAAK,WAAU;8DAAiB,aAAa,IAAI;;;;;;;;;;;;wCAGhF,aAAa,GAAG,KAAK,aAAa,aAAa,GAAG,KAAK,sBACtD,6LAAC;;gDAAE;8DACc,6LAAC;oDAAK,WAAU;8DAAiB,aAAa,GAAG;;;;;;;;;;;;wCAGnE,aAAa,QAAQ,kBACpB,6LAAC;4CAAE,WAAU;;gDAAgC;gDACb,IAAI,KAAK,aAAa,QAAQ,EAAE,cAAc;;;;;;;;;;;;;;;;;;;;mBArDnF;;;;;YA8DX;;;;;;;AAGN;GAlIwB;KAAA"}}]
}